<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gamer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.js" integrity="sha512-9mpsATI0KClwt+xVZfbcf2lJ8IFBAwsubJ6mI3rtULwyM3fBmQFzj0It4tGqxLOGQwGfJdk/G+fANnxfq9/cew==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
  
   <section class="world"></section>
   <section class="login">
    <input type="text" placeholder="Nick" class="input">
    <button class="button">Go</button>
   </section>

   <script type="text/javascript">
    
    let socket = io('http://localhost:3000')
    const button = document.querySelector(".button")
    const input = document.querySelector(".input")
    const world = document.querySelector(".world")
    let dataBase = []

    button.addEventListener('click', function(){
        localStorage.clear()
        localStorage.setItem('nick', input.value)
        socket.emit('login', {name: input.value, x: 255, y:20})
    })

    socket.on("synchronize", data => {
        dataBase = data
        player()
    })

    function player(){
        world.innerHTML = "";
        dataBase.forEach(player => {
            const {name, x, y} = player
            const div = document.createElement("div")
            div.className = "player";
            div.style.margin = `${y}px ${x}px`;
            const namePlayer = document.createElement("p")
            namePlayer.innerText = name;
            const sprite = document.createElement("img")
            sprite.src = "../img/sprite.png"
            div.appendChild(namePlayer)
            div.appendChild(sprite)
            world.appendChild(div)
        });
    }

    function updatePlayer(name, valueX, valueY){
        let newDataBase = dataBase.filter(player => player.name !== name)
        newDataBase.push({name, x:valueX, y:valueY})
        socket.emit('update', newDataBase)
    }

    function motion(evt){
        const nick = localStorage.getItem("nick");
        const player = dataBase.find(player => player.name === nick)
        const {name, x, y} = player

        let valueX = x
        let valueY = y

        if(evt.key === "ArrowLeft"){
        valueX -= 10;
        }
        if(evt.key === "ArrowRight"){
        valueX += 10;
        }
        if(evt.key === "ArrowUp"){
        valueY -= 10;
        }
        if(evt.key === "ArrowDown"){
        valueY += 10;
        }

        updatePlayer(name, valueX, valueY)
    }

    document.body.addEventListener("keydown", function(evt){
        const motions = ["ArrowLeft", "ArrowRight", "ArrowUp", "ArrowDown"]
        motions.forEach((element, index) => {
            if(evt.key === motions[index]){
                motion(evt)
            }
        });
    });

   </script>
</body>
</html>

